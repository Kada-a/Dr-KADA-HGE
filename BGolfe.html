<!DOCTYPE html>
<html>
<head>
    <title>Marché Temps Réel</title>
    <style>
        body { font-family: sans-serif; }
        #market-dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; max-width: 1000px; margin: 20px auto; }
        .market-section { border: 1px solid #ccc; padding: 15px; }
        .market-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .market-table th, .market-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .market-table th { background-color: #f0f0f0; }
        .stock-chart { height: 150px; border: 1px solid #eee; margin-top: 5px;}
        .positive-change { color: green; }
        .negative-change { color: red; }
        .error-message { color: red; font-weight: bold; }
        .loading-message { font-style: italic; color: grey; }
        .data-value { text-align: right; }
        .data-table-container { position: relative; }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Marché Temps Réel </h1>
    <p><strong><p class="error-message" id="api-error-message" style="display:none;">Erreur lors de la récupération des données du marché. Veuillez vérifier la console JavaScript pour plus de détails.</p>

    <div id="market-dashboard">
        <div class="market-section">
            <h2>Top 10 Actions Mondiales</h2>
            <div class="data-table-container">
                <div class="loading-overlay" id="top-global-stocks-loading" style="display:none;">
                    <div class="loading-spinner"></div>
                </div>
                <table class="market-table">
                    <thead>
                        <tr>
                            <th>Symbole</th>
                            <th>Nom</th>
                            <th>Prix</th>
                            <th>Variation (%)</th>
                            <th>Graphique</th>
                        </tr>
                    </thead>
                    <tbody id="top-global-stocks">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="market-section">
            <h2>Bourse du Qatar (QSE)</h2>
             <div class="data-table-container">
                <div class="loading-overlay" id="qatar-stock-exchange-loading" style="display:none;">
                    <div class="loading-spinner"></div>
                </div>
                <table class="market-table">
                    <thead>
                        <tr>
                            <th>Symbole</th>
                            <th>Nom</th>
                            <th>Prix</th>
                            <th>Variation (%)</th>
                            <th>Graphique</th>
                        </tr>
                    </thead>
                    <tbody id="qatar-stock-exchange">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="market-section">
            <h2>Bourse d'Arabie Saoudite (Tadawul)</h2>
             <div class="data-table-container">
                <div class="loading-overlay" id="saudi-stock-exchange-loading" style="display:none;">
                    <div class="loading-spinner"></div>
                </div>
                <table class="market-table">
                    <thead>
                        <tr>
                            <th>Symbole</th>
                            <th>Nom</th>
                            <th>Prix</th>
                            <th>Variation (%)</th>
                            <th>Graphique</th>
                        </tr>
                    </thead>
                    <tbody id="saudi-stock-exchange">
                    </tbody>
                </table>
            </div>

    <script>
        const apiKey = 't84SFJwRoBlas_6mIjM3lAOfwoCAVw4j'; // Remplacez par votre clé API Polygon
        const baseUrl = 'https://api.polygon.io/v2/aggs/ticker/';
        const apiErrorMessage = document.getElementById('api-error-message');

        const stockSymbols = {
            'top-global-stocks': [
                { symbol: "MSFT", name: "Microsoft" },
                { symbol: "AAPL", name: "Apple" },
                { symbol: "GOOGL", name: "Alphabet" },
                { symbol: "AMZN", name: "Amazon" },
                { symbol: "META", name: "Meta Platforms" }
            ],
            'qatar-stock-exchange': [
                { symbol: "QNBK.QA", name: "Qatar National Bank" },
                { symbol: "CBQK.QA", name: "Commercial Bank" }
            ],
            'saudi-stock-exchange': [
                { symbol: "2222.SR", name: "Saudi Aramco" },
                { symbol: "1120.SR", name: "Saudi National Bank" }
            ]
        };

        async function fetchMarketData(symbols, exchange, tableId) {
            const data = {};

            showLoading(tableId); // Afficher l'indicateur de chargement

            for (const symbol of symbols) {
                try {
                    const response = await fetch(`${baseUrl}${symbol.symbol}/prev?adjusted=true&apiKey=${apiKey}`);
                    if (!response.ok) {
                        throw new Error(`Erreur API pour ${symbol.symbol}: ${response.status} ${response.statusText}`);
                    }
                    const jsonData = await response.json();
                    if (jsonData.results && jsonData.results.length > 0) {
                        data[symbol.symbol] = parseApiResponse(jsonData.results[0]);
                    } else {
                        console.warn(`Aucune donnée pour ${symbol.symbol}:`, jsonData);
                        data[symbol.symbol] = null;
                    }
                } catch (error) {
                    console.error("Erreur lors de la récupération des données pour", symbol.symbol, error);
                    apiErrorMessage.style.display = 'block';
                    hideLoading(tableId);
                    return null;
                }
            }
            hideLoading(tableId);
            return data;
        }

        function parseApiResponse(quoteData) {
            return {
                price: quoteData.c, // Prix de clôture
                changePercent: ((quoteData.c - quoteData.o) / quoteData.o * 100).toFixed(2) // Pourcentage de changement
            };
        }

        // Les autres fonctions restent inchangées

        // Mise à jour initiale et rafraîchissement périodique
        updateMarketData();
        setInterval(updateMarketData, 60000); // Rafraîchir toutes les minutes
    </script>
</body>
</html>
