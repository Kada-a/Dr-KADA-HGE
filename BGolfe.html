<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BGolfe - Gulf Markets</title>
  <!-- Load Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date adapter for time scales -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <!-- Load Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background: #f8f9fa;
    }
    .controls {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    select, button, input {
      padding: 10px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      background: #fff;
    }
    /* Ensure the chart container has a fixed height */
    #chart-container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      height: 500px;  /* Added fixed height */
    }
    /* Make sure the canvas takes the full container height */
    #stockChart {
      width: 100%;
      height: 100%;
    }
    .indicator-checkboxes {
      display: flex;
      gap: 15px;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gulf Markets</h1>
    
    <div class="controls">
      <div>
        <label for="symbol1">Symbol 1:</label>
        <select id="symbol1">
          <option value="2222.SR">Saudi Aramco</option>
          <option value="1120.SR">Al Rajhi Bank</option>
          <option value="QNBK.QA">QNB Qatar</option>
        </select>
      </div>
      
      <div>
        <label for="symbol2">Symbol 2:</label>
        <select id="symbol2">
          <option value="">-- Compare with --</option>
          <option value="EMAAR.DU">Emaar Dubai</option>
          <option value="STC.SR">STC Saudi</option>
        </select>
      </div>
      
      <div>
        <label for="interval">Interval:</label>
        <select id="interval">
          <option value="5min">5 minutes</option>
          <option value="15min">15 minutes</option>
          <option value="30min">30 minutes</option>
          <option value="60min">1 hour</option>
        </select>
      </div>
      
      <div class="indicator-checkboxes">
        <label>
          <input type="checkbox" id="sma"> SMA 20
        </label>
        <label>
          <input type="checkbox" id="rsi"> RSI 14
        </label>
      </div>
    </div>
    
    <div id="chart-container">
      <canvas id="stockChart"></canvas>
    </div>
  </div>
  
  <script>
    let chart;
    let updateInterval;
    const apiKey = ''; // Check that your API key is valid
    
    const colors = {
      primary: '#2962ff',
      secondary: '#ff6d00',
      volume: '#78909c',
      sma: '#00c853',
      rsi: '#d500f9'
    };
    
    async function initChart() {
      const ctx = document.getElementById('stockChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              type: 'time',
              time: { tooltipFormat: 'PP HH:mm' }
            },
            y: { 
              position: 'left', 
              title: { display: true, text: 'Price' }
            },
            yVolume: {
              position: 'right',
              grid: { display: false },
              title: { display: true, text: 'Volume' }
            }
          },
          plugins: {
            zoom: {
              zoom: { wheel: { enabled: true }, mode: 'x' }
            }
          }
        }
      });
    }
    
    async function fetchData(symbol, interval) {
      try {
        const response = await axios.get(
          `https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${symbol}&interval=${interval}&apikey=${apiKey}`
        );
        console.log(`Response for ${symbol}:`, response.data);
        const timeSeries = response.data[`Time Series (${interval})`];
        if (!timeSeries) {
          console.error('No data returned for symbol:', symbol, response.data);
          return [];
        }
        return Object.entries(timeSeries).map(([time, values]) => ({
          t: new Date(time),
          y: parseFloat(values['4. close']),
          v: parseFloat(values['5. volume'])
        })).reverse();
      } catch (error) {
        console.error('Error fetching data for symbol:', symbol, error);
        return [];
      }
    }
    
    async function fetchIndicator(symbol, functionName, interval, options) {
      try {
        const response = await axios.get(
          `https://www.alphavantage.co/query?function=${functionName}&symbol=${symbol}&interval=${interval}&time_period=${options.timePeriod}&series_type=close&apikey=${apiKey}`
        );
        console.log(`Indicator response for ${symbol} (${functionName}):`, response.data);
        const indicatorData = response.data[`Technical Analysis: ${functionName}`];
        if (!indicatorData) {
          console.error('No indicator data returned for symbol:', symbol, response.data);
          return [];
        }
        return Object.entries(indicatorData).map(([time, values]) => ({
          t: new Date(time),
          y: parseFloat(values[functionName])
        })).reverse();
      } catch (error) {
        console.error(`Error fetching ${functionName} indicator for symbol:`, symbol, error);
        return [];
      }
    }
    
    function updateChart(data) {
      chart.data.datasets = [];
    
      data.forEach((stockData, index) => {
        const color = index === 0 ? colors.primary : colors.secondary;
        
        // Price dataset
        chart.data.datasets.push({
          label: `${stockData.symbol} - Price`,
          data: stockData.prices,
          borderColor: color,
          yAxisID: 'y',
          tension: 0.1,
          fill: false
        });
    
        // Volume dataset (hidden by default)
        chart.data.datasets.push({
          label: `${stockData.symbol} - Volume`,
          data: stockData.prices.map(p => ({ x: p.t, y: p.v })),
          type: 'bar',
          backgroundColor: colors.volume,
          yAxisID: 'yVolume',
          hidden: true
        });
    
        // SMA indicator dataset
        if (stockData.sma && stockData.sma.length > 0) {
          chart.data.datasets.push({
            label: `${stockData.symbol} - SMA 20`,
            data: stockData.sma,
            borderColor: colors.sma,
            borderDash: [5, 5],
            yAxisID: 'y',
            fill: false
          });
        }
    
        // RSI indicator dataset
        if (stockData.rsi && stockData.rsi.length > 0) {
          chart.data.datasets.push({
            label: `${stockData.symbol} - RSI 14`,
            data: stockData.rsi,
            borderColor: colors.rsi,
            yAxisID: 'y',
            fill: false
          });
        }
      });
    
      chart.update();
    }
    
    async function loadData() {
      const interval = document.getElementById('interval').value;
      const symbol1 = document.getElementById('symbol1').value;
      const symbol2 = document.getElementById('symbol2').value;
      const symbols = [symbol1, symbol2].filter(Boolean);
    
      const showSMA = document.getElementById('sma').checked;
      const showRSI = document.getElementById('rsi').checked;
    
      // Attempt to fetch API data
      const allData = await Promise.all(symbols.map(async symbol => {
        const prices = await fetchData(symbol, interval);
        const sma = showSMA ? await fetchIndicator(symbol, 'SMA', interval, { timePeriod: 20 }) : null;
        const rsi = showRSI ? await fetchIndicator(symbol, 'RSI', interval, { timePeriod: 14 }) : null;
        return { symbol, prices, sma, rsi };
      }));
    
      // Check if data is empty and use fallback dummy data for testing
      const isDataEmpty = allData.every(stock => stock.prices.length === 0);
      if (isDataEmpty) {
        console.warn("No data returned from API, using fallback dummy data for testing.");
        const dummyTime = new Date();
        const dummyPrices = Array.from({ length: 10 }, (_, i) => ({
          t: new Date(dummyTime.getTime() + i * 60000),
          y: 100 + i,
          v: 1000 + i * 10
        }));
        allData.push({
          symbol: "DUMMY",
          prices: dummyPrices,
          sma: null,
          rsi: null
        });
      }
    
      updateChart(allData);
    }
    
    window.onload = async () => {
      await initChart();
      loadData();
      updateInterval = setInterval(loadData, 300000); // Refresh every 5 minutes
    
      document.querySelectorAll('select, input').forEach(element => {
        element.addEventListener('change', () => {
          clearInterval(updateInterval);
          loadData();
          updateInterval = setInterval(loadData, 300000);
        });
      });
    };
  </script>
</body>
</html>
